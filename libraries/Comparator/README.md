# Comparator
A library for interfacing with the analog comparator peripheral in the AVR DA and DB series MCUs.
Developed by [MCUdude](https://github.com/MCUdude/).
The AVR DA/DB has three comparators with up to four positive and three negative pins each available for use. The DD-series will have one, with fewer input options. An alternative for the negative pin is to use an internally generated reference voltage instead, generated from one of the internal reference options and then scaled by an internal DAC. Unlike the tinyAVR 1-series parts, none of the comparators share a DAC with DAC0.


## Comparator
Class for interfacing with the built-in comparator. Use the predefined objects `Comparator`/`Comparator0`, `Comparator1` or `Comparator2`. (`Comparator` is #defined as `Comparator0` to permit compatibility with parts that have only a single comparator and use the same or similar library). The available inputs for DA and DB-series parts are shown in the table below; on 28-pin and 32-pin parts, alongside the pins for the single analog comparator on the DD-series.

Input |   AC0   |   AC1   |   AC2   |  DD AC0 |
------|---------|---------|---------|---------|
AINP0 | PIN_PD2 | PIN_PD2 | PIN_PD2 | PIN_PD2 |
AINP1 | PIN_PE0 | PIN_PD4 | PIN_PD4 |   n/a   |
AINP2 | PIN_PE2 | PIN_PD4 | PIN_PE1 |   n/a   |
AINP3 | PIN_PD6 | PIN_PD6 | PIN_PD6 | PIN_PD6 |
AINP4 |   n/a   |   n/a   |   n/a   | PIN_PC2 |
AINN0 | PIN_PD3 | PIN_PD5 | PIN_PD7 | PIN_PD3 |
AINN1 | PIN_PD0 | PIN_PD0 | PIN_PD0 |   n/a   |
AINN2 | PIN_PD7 | PIN_PD7 | PIN_PD7 | PIN_PD7 |
AINN3 |   n/a   |   n/a   |   n/a   | PIN_PC3 |

### input_p
Variable for setting what input pin the positive input of the comparator should be connected to
Accepted values:
``` c++
in_p::in0; // Use positive input pin 0 as input. This is always PD2.
in_p::in1; // Use positive input pin 1 as input (not available on DD-series)
in_p::in2; // Use positive input pin 2 as input (not available on DD-series)
in_p::in3; // Use positive input pin 3 as input. This is always PD6, the DAC output pin.
in_p::in4; // Use positive input pin 4 as input (DD-series only, requires MVIO to be disabled)
in_p::pd2; // Synonym for in_p::in0, which is PD2 on all DxCore parts
in_p::pd6; // Synonym for in_p::in3, which is PD6 on all DxCore parts
```

##### Usage
``` c++
Comparator.input_p = in_p::in0;  // Connect positive input pin 0 to the positive pin of the comparator
```

##### Default state
`Comparator.input_p` defaults to `in_p::in0` if not specified in the user program.


### input_n
Variable for setting what input pin the negative input of the comparator should be connected to
Accepted values:
``` c++
in_n::in0;    // Use negative input pin 0 as input
in_n::in1;    // Use negative input pin 1 as input. This is always PD0, (not available on DD, 28/32-pin DB-series)
in_n::in2;    // Use negative input pin 2 as input. This is always PD7, the external VREF pin.
in_n::in3;    // Use negative input pin 3 as input (DD-series only, requires MVIO to be disabled)
in_n::dacref; // Use DACREF as input
in_n::pd0;    // Synonym for in_n::in1, which is PD0 on all DxCore parts that have this input
in_n::pd7;    // Synonym for in_n::in2, which is PD7 on all DxCore parts
```

##### Usage
``` c++
Comparator.input_n = in_n::in0;  // Connect negative input pin 0 to the negative pin of the comparator
```

##### Default state
`Comparator.input_n` defaults to `in_n::in0` if not specified in the user program.


### reference
Variable for setting what reference voltage the DACREF should be derived from. This voltage is internally generated by the VREF peripheral. Note that there is only a single reference voltage for the all three comparators. To avoid unintended changes to the voltage reference settings, when any comparator is initialized, it will also write - to the `reference` property of the other two comparator objects - the same value that it just wrote to the VREF.ACREF register. If a change in the reference voltage is desired, set `reference` on any of the comparatory and call their `init()` method.
Accepted values:
``` c++
ref::disable;    // Do not use any reference
ref::vref_1v024; // 1.02V internal voltage
ref::vref_2v048; // 2.05V internal voltage
ref::vref_2v500; // 2.5V internal voltage
ref::vref_2v5;
ref::vref_4v096; // 4.1V internal voltage
ref::vref_vdd;   // VDD as reference
ref::vref_vrefa; // External reference from the VREFA pin
```

##### Usage
``` c++
Comparator.reference = ref::vref_4v096;  // Use the internal 4.096V reference for the DACREF
```

##### Default state
`Comparator.reference` defaults to `ref::disable` if not specified in the user program.


### dacref
Variable for setting the DACREF value - this voltage can be selected as the input for the negative side of the comparator.
This is the formula for the DACREF output voltage:

<img src="http://latex.codecogs.com/svg.latex?V_{DACREF} = \frac{Comparator.dacref}{256} * Comparator.reference" border="0"/>

##### Usage
``` c++
Comparator.dacref = 127;  // Divide the reference voltage by two
```

##### Default state
`Comparator.dacref` defaults to `255` if not specified in the user program.


### hysteresis
Variable for setting the comparator input hysteresis. Useful for eliminating "bouncing".
Accepted values:
``` c++
hyst::disable; // No hysteresis
hyst::small;   // 10mV hysteresis (±5mV)
hyst::medium;  // 25mV hysteresis (±12.5mV)
hyst::large;   // 50mV hysteresis (±25mV)
```

##### Usage
``` c++
Comparator.hysteresis = hyst::large;  // Use 50V hysteresis
```

##### Default state
`Comparator.hysteresis` defaults to `hyst::disable` if not specified in the user program.


### output
Variable for setting the comparator output - either internal or external, inverted or not (note also that the pin itself could be inverted with the INVEN bit of PORTA.PIN7CTRL (or PORTC.PIN6CTRL if alternate output pin is used; this allows the pin to take a logical state opposite from tne internal (event channel) output, thus allowing every possible combination of external and internal output polarities.
Accepted values:
``` c++
out::disable;        // No output pin, signal not inverted internally
out::disable_invert; // No output pin, signal inverted internally
out::enable;         // Enable output pin (PA7), signal not inverted internally
out::invert;         // Enable output pin (PA7), signal inverted internally
out::enable_invert;  // Identical to out::invert
```

##### Usage
``` c++
Comparator.output = out::enable; // Enable output pin (PA7)
```

##### Default state
`Comparator.output` defaults to `out::disable` if not specified in the user program.


### output_swap
Variable for pin swapping the physical output pin to its alternative position. See the pinout diagrams in the DxCore README for detailed info.
Accepted values:
```c++
out::no_swap;  // Use default pin position
out::pin_swap; // Use alternative position (48 and 64-pin parts only)
```

##### Usage
```c++
Comparator.output_swap = out::no_swap; // No pin swap for output
```

##### Default state
`Comparator.output_swap` defaults to `out::no_swap` if not specified in the user program.


### output_initval
Initial state the comparator output pin has when initialized.
Accepted values:
```c++
out::init_low;  // Output pin low after initialization
out::init_high; // Output pin high after initialization
```

##### Usage
```c++
Comparator.output_initval = out::init_high;
```

##### Default state
`Comparator.output_initval` defaults to `out::init_low` if not specified in the user program.


## init()
Method for initializing the comparator.

##### Usage
```c++
Comparator.init(); // Initialize comparator
```

## start()
Method for starting the analog comparator.
##### Usage
```c++
Comparator.start(); // Start comparator
```


## stop()
Method for stopping the analog comparator.

##### Usage
```c++
Comparator.stop(); // Stop comparator
```

## read()
Method to read current comparator value; returns the comparator output as a bool; this is effected by output invert.

##### Usage
```c++

if (Comparator0.read()) {
  doSomething();
}
```


## attachInterrupt()
Method for enabling analog comparator interrupt. The interrupt will trigger when the the comparator output changes.
Valid arguments for the third parameters are `RISING`, `FALLING` and `CHANGE`. Clearing of the INTFLAG is handled by the library, and does not need to be done in your interrupt code.

##### Usage
```c++
Comparator.attachInterrupt(blinkLED, RISING); // Run the blinkLED function when the comparator output goes high

void blinkLED() {
  digitalWrite(myLedPin, CHANGE);
}
```


## detachInterrupt()
Method for disabling analog comparator interrupt.

##### Usage
```c++
Comparator.detachInterrupt(); // Disable interrupt
```
